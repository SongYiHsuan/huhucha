<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>å£ºå£ºèŒ¶-ç·šä¸Šä¸‹å–®</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      height: 100%;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "PingFang TC", "Microsoft JhengHei", sans-serif;
      background: #f5f5f7;
      color: #222;
    }
    .app {
      max-width: 960px;
      margin: 0 auto;
      height: 100vh;          /* åŸæœ¬æ˜¯ min-height: 100vh; æ”¹æˆå›ºå®šé«˜åº¦ */
      display: flex;
      flex-direction: column;
    }
    
    header {
      padding: 12px 16px;
      background: #ffffff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.06);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    header h1 {
      font-size: 20px;
      font-weight: 700;
    }
    header button {
      border: none;
      background: none;
      font-size: 14px;
      color: #2253a0;
      cursor: pointer;
    }

    .main {
      display: flex;
      flex: 1;
      padding: 12px 8px 88px;
      gap: 8px;
      overflow: hidden;
    }

    /* å·¦é‚Šåˆ†é¡ */
    .category-panel {
      width: 26%;
      max-width: 220px;
      background: #ffffff;
      border-radius: 16px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    #categoryList {
      flex: 1;
      display: flex;
      flex-direction: column;  /* å‚ç›´æ’åˆ—æŒ‰éˆ• */
      gap: 4px;
      overflow-y: auto;        /* ä¸Šä¸‹æ²å‹• */
      overflow-x: hidden;      /* ä¸è¦å·¦å³æ²å‹• */
    }
      
    #categoryList::-webkit-scrollbar {
      height: 6px;           /* å¯é¸ï¼šè®“æ©«å‘æ²è»¸å°ä¸€é»å¥½çœ‹ */
    }
    .category-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .category-btn {
      width: 100%;
      padding: 8px 10px;
      border-radius: 12px;
      border: none;
      text-align: left;
      font-size: 14px;
      cursor: pointer;
      background: transparent;
    }
    .category-btn.active {
      background: #cfe3f3;
      color: #2253a0;
      font-weight: 600;
    }

    /* ä¸­é–“å“é … */
    .item-panel {
      flex: 1;
      background: #ffffff;
      border-radius: 16px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .section-header h2 {
      font-size: 16px;
      font-weight: 600;
    }
    .item-list {
      flex: 1;      
      overflow-y: auto;
      padding-right: 4px;
    }
    .item-card {
      border-radius: 14px;
      border: 1px solid #eee;
      padding: 10px 12px;
      margin-bottom: 8px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 6px;
      transition: box-shadow 0.15s ease, transform 0.08s ease;
    }
    .item-card:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transform: translateY(-1px);
    }
    .item-name {
      font-size: 15px;
      font-weight: 500;
    }
    .item-info {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      font-size: 14px;
    }
    .item-price {
      font-weight: 700;
      color: #2253a0;
    }
    .item-stock {
      font-size: 12px;
      color: #888;
    }

    /* å³é‚Šè³¼ç‰©è»Š(æ¡Œæ©Ÿé¡¯ç¤º) */
    .cart-panel {
      width: 28%;
      max-width: 260px;
      background: #ffffff;
      border-radius: 16px;
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      /* â˜… æ–°å¢é€™è¡Œï¼Œè®“å­å…ƒç´ å¯ä»¥æ­£ç¢ºåˆ†é…é«˜åº¦ */
      min-height: 0;
    }
    .cart-item {
      padding: 6px 0;
      border-bottom: 1px solid #f0f0f0;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .cart-top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .cart-name {
      font-weight: 500;
    }
    .cart-line-total {
      font-weight: 600;
      color: #2253a0;
    }
    .cart-bottom-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .qty-control {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .qty-btn {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      background: #e0e7ff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .qty-value {
      width: 24px;
      text-align: center;
    }

    .cart-empty {
      margin-top: 12px;
      font-size: 13px;
      color: #777;
    }

    .cart-summary {
      margin-top: 8px;
      border-top: 1px solid #eee;
      padding-top: 8px;
      font-size: 14px;
    }
    .cart-summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 3px;
    }
    .cart-summary-row strong {
      font-weight: 700;
    }
    .checkout-btn {
      margin-top: 8px;
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 10px 0;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      background: #2253a0;
      color: #fff;
    }
    .checkout-btn:disabled {
      background: #d1d5db;
      cursor: default;
    }
    /* è³¼ç‰©è»Šå…§ä¾åˆ†é¡ç¾¤çµ„çš„æ¨™é¡Œ */
    .cart-category-title {
      margin-top: 6px;
      font-size: 13px;
      font-weight: 600;
      color: #444;
    }
    
    /* è®“å“é …çœ‹èµ·ä¾†æ˜¯åˆ†é¡åº•ä¸‹ï¼Œç”¨ä¸€é»ç¸®æ’ */
    .cart-item {
      padding: 6px 0;
      padding-left: 8px;      /* â˜… æ–°å¢ç¸®æ’ */
      border-bottom: 1px solid #f0f0f0;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    /* åº•éƒ¨å›ºå®šè¨Šæ¯/éŒ¯èª¤ */
    .toast {
      position: fixed;
      left: 50%;
      bottom: 12px;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.85);
      color: #fff;
      padding: 8px 14px;
      border-radius: 999px;
      font-size: 13px;
      z-index: 50;
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s ease;
    }
    .toast.show {
      opacity: 1;
      pointer-events: auto;
    }

    /* æœƒå“¡è³‡æ–™å½ˆçª— & è³¼ç‰©è»Šå½ˆçª—å…±ç”¨ */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }
    .modal-backdrop.show {
      display: flex;
    }
    .modal {
      background: #ffffff;
      border-radius: 16px;
      padding: 16px 18px;
      width: 90%;
      max-width: 420px;
    }
    .modal.cart-modal {
      max-height: 80vh;
      display: flex;
      flex-direction: column;
    }
    #cartModalList {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      min-height: 0;
    }
    .modal h2 {
      font-size: 18px;
      margin-bottom: 8px;
      font-weight: 700;
    }
    .modal p {
      font-size: 13px;
      color: #666;
      margin-bottom: 8px;
    }
    .field {
      margin-bottom: 10px;
    }
    .field label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
    }
    .field input, .field textarea {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      resize: vertical;
    }
    .modal-actions {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    .btn-secondary {
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      background: #e5e7eb;
      font-size: 14px;
      cursor: pointer;
    }
    .btn-primary {
      padding: 8px 18px;
      border-radius: 999px;
      border: none;
      background: #2253a0;
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    /* æµ®å‹•è³¼ç‰©è»ŠæŒ‰éˆ•ï¼ˆæ‰‹æ©Ÿç”¨ï¼‰ */
    .cart-fab {
      display: none; /* é è¨­éš±è—ï¼Œæ‰‹æ©Ÿç‰ˆæ‰é¡¯ç¤º */
      position: fixed;
      right: 16px;
      bottom: 16px;
      border-radius: 999px;
      border: none;
      padding: 10px 16px;
      font-size: 14px;
      font-weight: 600;
      background: #2253a0;
      color: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.25);
      z-index: 45;
      align-items: center;
      gap: 4px;
    }
    .cart-fab span {
      font-weight: 700;
    }

    @media (max-width: 768px) {
      .main {
        flex-direction: column;
        padding-bottom: 80px;
      }
      .category-panel {
        width: 100%;
        max-width: none;
        border-radius: 0;
        border-bottom-left-radius: 16px;
        border-bottom-right-radius: 16px;
      }
      .category-title {
        display: none;
      }
    
      /* åŸæœ¬é€™è£¡çš„ .category-btn æ”¹æˆé€™æ¨£ */
      .category-btn {
        flex: 0 0 25%;       /* å›ºå®šä½”ä¸€åˆ—çš„ 1/4 */
        max-width: 25%;
        white-space: nowrap; /* æ–‡å­—ä¸è¦æ›è¡Œ */
        flex-shrink: 0;
        text-align: center;  /* ç½®ä¸­æ¯”è¼ƒåƒ Tab æ¨™ç±¤ */
        padding: 6px 4px;    /* ç¸®å°ä¸€é» paddingï¼ŒæŒ‰éˆ•æ¯”è¼ƒä¸æœƒå¤ªé«˜ */
        font-size: 13px;
      }
    
      #categoryList {
        display: flex;
        flex-direction: row;
        gap: 4px;
        overflow-x: auto;
        overflow-y: hidden;
      }
    
      .item-panel {
        width: 100%;
        margin-top: 8px;
      }
    
      .cart-panel {
        display: none;
      }
    
      .cart-fab {
        display: flex;
      }
    }
    
    #deliveryRow {
      cursor: pointer;
    }
    #cartList {
      flex: 1;              /* åƒæ‰å‰©é¤˜é«˜åº¦ */
      overflow-y: auto;     /* å‚ç›´æ²å‹• */
      padding-right: 4px;   /* é¿å…æ²è»¸è“‹ä½å…§å®¹ï¼Œå¯è¦–éœ€è¦èª¿æ•´ */
      min-height: 0;        /* æ­é… flex æ­£å¸¸æ”¶ç¸® */
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>å£ºå£ºèŒ¶</h1>
    <button id="memberButton">æœƒå“¡è³‡æ–™</button>
  </header>

  <div class="main">
    <aside class="category-panel">
      <div class="category-title">åˆ†é¡</div>
      <div id="categoryList"></div>
    </aside>

    <main class="item-panel">
      <div class="section-header">
      <h2 id="currentCategoryTitle"></h2>
        <span style="font-size:12px;color:#999;">é»æ“Šå“é …å³å¯åŠ å…¥è³¼ç‰©è»Š</span>
      </div>
      <div class="item-list" id="itemList"></div>
    </main>

    <aside class="cart-panel">
      <div class="section-header">
        <h2>è³¼ç‰©è»Š</h2>
      </div>
      <div id="cartList"></div>
      <div class="cart-summary" id="cartSummary"></div>
      <button class="checkout-btn" id="checkoutBtn" disabled>é€å‡ºè¨‚å–®</button>
    </aside>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- æœƒå“¡è³‡æ–™ Modal -->
<div class="modal-backdrop" id="memberModal">
  <div class="modal">
    <h2>æœƒå“¡è³‡æ–™</h2>
    <p>ç¬¬ä¸€æ¬¡ä¸‹å–®è«‹å…ˆå¡«å¯«ï¼Œä¸‹æ¬¡æœƒè‡ªå‹•å¸¶å…¥ï¼Œå¯åœ¨æ­¤ç•«é¢ä¿®æ”¹ã€‚</p>
    <div class="field">
      <label for="memberName">å§“å</label>
      <input id="memberName" type="text" autocomplete="name" />
    </div>
    <div class="field">
      <label for="memberPhone">é›»è©±</label>
      <input id="memberPhone" type="tel" autocomplete="tel" />
    </div>
    <div class="field">
      <label for="memberAddress">åœ°å€</label>
      <textarea id="memberAddress" rows="2"></textarea>
    </div>
    <div class="field" id="deliveryRow">
      <label>å¸Œæœ›é€é”æ™‚é–“</label>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <input id="deliveryDate" type="date"
               style="flex:1 1 120px; min-width:120px;" />
        <select id="deliveryHour" style="flex:0 0 72px; min-width:72px;"></select>
        <select id="deliveryMinute" style="flex:0 0 72px; min-width:72px;"></select>
      </div>
</div>
    <div class="modal-actions">
      <button class="btn-secondary" id="memberCancelBtn">å–æ¶ˆ</button>
      <button class="btn-primary" id="memberSaveBtn">å„²å­˜</button>
    </div>
  </div>
</div>

<!-- æ‰‹æ©Ÿç”¨ï¼šæµ®å‹•è³¼ç‰©è»ŠæŒ‰éˆ• -->
<button class="cart-fab" id="cartFab">
  ğŸ›’<span id="cartFabCount">0</span>
</button>

<!-- æ‰‹æ©Ÿç”¨ï¼šè³¼ç‰©è»Š Modal -->
<div class="modal-backdrop" id="cartModal">
  <div class="modal cart-modal">
    <h2>è³¼ç‰©è»Š</h2>
    <div id="cartModalList"></div>
    <div class="cart-summary" id="cartModalSummary"></div>
    <div class="modal-actions">
      <button class="btn-secondary" id="cartModalCloseBtn">é—œé–‰</button>
      <button class="btn-primary" id="cartModalCheckoutBtn">é€å‡ºè¨‚å–®</button>
    </div>
  </div>
</div>

<script>
  // ==== è¨­å®šä½ çš„ Apps Script Web App URL ====
  const API_BASE_URL = "https://script.google.com/macros/s/AKfycbwWcFJ_im36pA_QJVfB_nbPpf3d1JJWA4dFf7EbRZySpIWkLo5wpFxmbJe85Tc3nUu9/exec";

  // ==== ç‹€æ…‹ ====
  let allItems = [];        // å¾ Sheet å–å¾—çš„å“é …åŸå§‹è³‡æ–™
  let categories = [];      // é¡åˆ¥åç¨±é™£åˆ—
  let currentCategory = "";
  let cart = [];            // [{ category, name, price, stock, quantity }]
  let member = {
    name: "",
    phone: "",
    address: "",
    deliveryTime: ""
  };

  // ==== DOM ====
  const categoryListEl = document.getElementById("categoryList");
  const itemListEl = document.getElementById("itemList");
  const cartListEl = document.getElementById("cartList");
  const cartSummaryEl = document.getElementById("cartSummary");
  const checkoutBtn = document.getElementById("checkoutBtn");
  const toastEl = document.getElementById("toast");
  const deliveryRow = document.getElementById("deliveryRow");
  const deliveryDateInput = document.getElementById("deliveryDate");
  const deliveryHourSelect = document.getElementById("deliveryHour");
  const deliveryMinuteSelect = document.getElementById("deliveryMinute");
  const memberButton = document.getElementById("memberButton");
  const memberSaveBtn = document.getElementById("memberSaveBtn");
  const memberCancelBtn = document.getElementById("memberCancelBtn");
  const memberModal = document.getElementById("memberModal");
  const memberNameInput = document.getElementById("memberName");
  const memberPhoneInput = document.getElementById("memberPhone");
  const memberAddressInput = document.getElementById("memberAddress");

  // æ‰‹æ©Ÿè³¼ç‰©è»Šç›¸é—œ DOM
  const cartFab = document.getElementById("cartFab");
  const cartFabCount = document.getElementById("cartFabCount");
  const cartModal = document.getElementById("cartModal");
  const cartModalListEl = document.getElementById("cartModalList");
  const cartModalSummaryEl = document.getElementById("cartModalSummary");
  const cartModalCloseBtn = document.getElementById("cartModalCloseBtn");
  const cartModalCheckoutBtn = document.getElementById("cartModalCheckoutBtn");

  // ==== å·¥å…· ====

  // åˆå§‹åŒ–é€é”æ™‚é–“çš„ã€Œå°æ™‚ / åˆ†é˜ã€é¸å–®
  function initDeliveryTimeSelectors() {
    // å°æ™‚ 00~23
    for (let h = 0; h < 24; h++) {
      const opt = document.createElement("option");
      const val = h.toString().padStart(2, "0");
      opt.value = val;
      opt.textContent = val;
      deliveryHourSelect.appendChild(opt);
    }
  
    // åˆ†é˜ 00 / 10 / 20 / 30 / 40 / 50
    [0, 10, 20, 30, 40, 50].forEach(m => {
      const opt = document.createElement("option");
      const val = m.toString().padStart(2, "0");
      opt.value = val;
      opt.textContent = val;
      deliveryMinuteSelect.appendChild(opt);
    });
  }


  function showToast(msg) {
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(() => toastEl.classList.remove("show"), 2200);
  }

  function loadMemberFromStorage() {
    try {
      const raw = localStorage.getItem("webOrderMember");
      if (raw) {
        const parsed = JSON.parse(raw);
        member = {
          name: parsed.name || "",
          phone: parsed.phone || "",
          address: parsed.address || "",
          deliveryTime: parsed.deliveryTime || ""
        };
      }
    } catch (e) {
      console.warn("load member failed", e);
    }
  }

  function saveMemberToStorage() {
    localStorage.setItem("webOrderMember", JSON.stringify(member));
  }

  /**
   * é–‹å•Ÿæœƒå“¡è³‡æ–™è¦–çª—
   * @param {boolean} force       æ˜¯å¦å¼·åˆ¶å¡«ï¼ˆå–æ¶ˆæ™‚ä¸èƒ½é—œé–‰ï¼‰
   * @param {boolean} fromCheckout æ˜¯å¦å¾ã€Œé€å‡ºè¨‚å–®ã€æµç¨‹é€²ä¾†
   */
    function openMemberModal(force = false, fromCheckout = false) {
      // å°‡ç›®å‰ member ç‹€æ…‹å¡«å› input
      memberNameInput.value = member.name || "";
      memberPhoneInput.value = member.phone || "";
      memberAddressInput.value = member.address || "";
    
      memberModal.dataset.checkout = fromCheckout ? "1" : "0";
    
      // ä¾ä¾†æºåˆ‡æ›æŒ‰éˆ•æ–‡å­—
      memberSaveBtn.textContent = fromCheckout ? "ç¢ºèªè¨‚å–®é€å‡º" : "å„²å­˜";
    
      if (fromCheckout) {
        deliveryRow.style.display = "block";
    
        // é è¨­æˆã€Œç¾åœ¨ã€æ™‚é–“ï¼Œåˆ†é˜å°é½Šåˆ° 10 åˆ†é˜ä¸€æ ¼
        const now = new Date();
    
        const yyyy = now.getFullYear();
        const mm = String(now.getMonth() + 1).padStart(2, "0");
        const dd = String(now.getDate()).padStart(2, "0");
    
        let hh = now.getHours();
        let m = now.getMinutes();
        m = Math.floor(m / 10) * 10;  // 0,10,20,30,40,50
    
        deliveryDateInput.value = `${yyyy}-${mm}-${dd}`;
        deliveryHourSelect.value = String(hh).padStart(2, "0");
        deliveryMinuteSelect.value = String(m).padStart(2, "0");
      } else {
        // å¾ã€Œæœƒå“¡è³‡æ–™ã€æŒ‰éˆ•é€²ä¾†ï¼šä¸éœ€è¦é€é”æ™‚é–“
        deliveryRow.style.display = "none";
      }
      cartModal.classList.remove("show");    
      memberModal.classList.add("show");
    }


    function closeMemberModal() {
      memberModal.classList.remove("show");
      memberModal.dataset.checkout = "0";
    }

  // ==== æŠ“èœå–® ====

  async function loadMenu() {
    try {
      const resp = await fetch(API_BASE_URL);
      const data = await resp.json();
      allItems = (data.items || []).filter(it => it.price != null);
  
      const catSet = new Set();
      allItems.forEach(it => catSet.add(it.category));
      categories = [...Array.from(catSet)];
  
      // é è¨­é¸ç¬¬ä¸€å€‹ç¨®é¡ï¼Œä¸¦è¨­å®šæ¨™é¡Œ
      if (categories.length > 0) {
        currentCategory = categories[0];
        document.getElementById("currentCategoryTitle").textContent = currentCategory;
      }
  
      renderCategories();
      renderItems();
    } catch (err) {
      console.error(err);
      showToast("è¼‰å…¥èœå–®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
    }
  }


  // ==== Render ====

  function renderCategories() {
    categoryListEl.innerHTML = "";
    categories.forEach(cat => {
      const btn = document.createElement("button");
      btn.className = "category-btn" + (cat === currentCategory ? " active" : "");
      btn.textContent = cat;
      btn.onclick = () => {
        currentCategory = cat;
        document.getElementById("currentCategoryTitle").textContent = cat;
        renderCategories();
        renderItems();
      };
      categoryListEl.appendChild(btn);
    });
  }

  function renderItems() {
    itemListEl.innerHTML = "";
    const items = allItems.filter(it => {
      if (!currentCategory) return true;
      return it.category === currentCategory;
    });

    if (!items.length) {
      itemListEl.innerHTML = '<p style="font-size:13px;color:#777;">ç›®å‰æ²’æœ‰å“é …</p>';
      return;
    }

    items.forEach(it => {
      const card = document.createElement("div");
      card.className = "item-card";
      card.onclick = () => addToCart(it);

      const nameEl = document.createElement("div");
      nameEl.className = "item-name";
      nameEl.textContent = it.item;

      const infoRow = document.createElement("div");
      infoRow.className = "item-info";

      const priceEl = document.createElement("span");
      priceEl.className = "item-price";
      priceEl.textContent = `$${it.price}`;

      const stockEl = document.createElement("span");
      const stockValue = it.stock != null ? it.stock : 0;
      stockEl.className = "item-stock";
      stockEl.textContent = `åº«å­˜ ${stockValue}`;

      infoRow.appendChild(priceEl);
      infoRow.appendChild(stockEl);

      card.appendChild(nameEl);
      card.appendChild(infoRow);

      itemListEl.appendChild(card);
    });
  }

  function createCartItemElement(item, onMinus, onPlus) {
    const container = document.createElement("div");
    container.className = "cart-item";

    const topRow = document.createElement("div");
    topRow.className = "cart-top-row";

    const nameEl = document.createElement("div");
    nameEl.className = "cart-name";
    nameEl.textContent = item.name;

    const lineTotalEl = document.createElement("div");
    lineTotalEl.className = "cart-line-total";
    lineTotalEl.textContent = `$${item.price * item.quantity}`;

    topRow.appendChild(nameEl);
    topRow.appendChild(lineTotalEl);

    const bottomRow = document.createElement("div");
    bottomRow.className = "cart-bottom-row";

    const priceInfo = document.createElement("span");
    priceInfo.style.fontSize = "12px";
    priceInfo.textContent = `å–®åƒ¹ $${item.price}`;

    const qtyControl = document.createElement("div");
    qtyControl.className = "qty-control";

    const minusBtn = document.createElement("button");
    minusBtn.className = "qty-btn";
    minusBtn.textContent = "-";
    minusBtn.onclick = onMinus;

    const qtyVal = document.createElement("span");
    qtyVal.className = "qty-value";
    qtyVal.textContent = item.quantity;

    const plusBtn = document.createElement("button");
    plusBtn.className = "qty-btn";
    plusBtn.textContent = "+";
    plusBtn.onclick = onPlus;

    if (item.quantity >= item.stock) {
      plusBtn.disabled = true;
      plusBtn.style.opacity = 0.4;
    }

    qtyControl.appendChild(minusBtn);
    qtyControl.appendChild(qtyVal);
    qtyControl.appendChild(plusBtn);

    bottomRow.appendChild(priceInfo);
    bottomRow.appendChild(qtyControl);

    container.appendChild(topRow);
    container.appendChild(bottomRow);

    return container;
  }

  function renderCart() {
    cartListEl.innerHTML = "";
    cartModalListEl.innerHTML = "";
  
    if (!cart.length) {
      const emptyHtml = '<div class="cart-empty">å°šæœªé¸æ“‡å“é …</div>';
      cartListEl.innerHTML = emptyHtml;
      cartModalListEl.innerHTML = emptyHtml;
      cartSummaryEl.innerHTML = "";
      cartModalSummaryEl.innerHTML = "";
      checkoutBtn.disabled = true;
      cartModalCheckoutBtn.disabled = true;
      cartFabCount.textContent = "0";
      return;
    }
  
    // å°è¨ˆ
    let subtotal = 0;
    cart.forEach(c => subtotal += c.price * c.quantity);
    cartFabCount.textContent = String(cart.length);
  
    // â˜… ä¾åˆ†é¡åˆ†çµ„ï¼š{ "A013": [item1, item2...], "A014": [...] }
    const grouped = {};
    cart.forEach(item => {
      const cat = item.category || "";
      if (!grouped[cat]) grouped[cat] = [];
      grouped[cat].push(item);
    });
  
    // â˜… ä¾åˆ†é¡é¡¯ç¤ºï¼šåˆ†é¡æ¨™é¡Œ + åº•ä¸‹å“é …
    Object.keys(grouped)
      .sort()                       // åˆ†é¡æ’åºï¼šA013, A014...
      .forEach(cat => {
        // åˆ†é¡æ¨™é¡Œï¼ˆæ¡Œæ©Ÿç‰ˆï¼‰
        if (cat) {
          const headerPC = document.createElement("div");
          headerPC.className = "cart-category-title";
          headerPC.textContent = cat;
          cartListEl.appendChild(headerPC);
  
          // åˆ†é¡æ¨™é¡Œï¼ˆæ‰‹æ©Ÿç‰ˆï¼‰
          const headerMobile = document.createElement("div");
          headerMobile.className = "cart-category-title";
          headerMobile.textContent = cat;
          cartModalListEl.appendChild(headerMobile);
        }
  
        // è©²åˆ†é¡åº•ä¸‹çš„æ‰€æœ‰å“é …
        grouped[cat].forEach(item => {
          // æ¡Œæ©Ÿç‰ˆ
          const pcElement = createCartItemElement(
            item,
            () => changeQty(item, -1),
            () => changeQty(item, +1)
          );
          cartListEl.appendChild(pcElement);
  
          // æ‰‹æ©Ÿ modal ç‰ˆ
          const mobileElement = createCartItemElement(
            item,
            () => changeQty(item, -1),
            () => changeQty(item, +1)
          );
          cartModalListEl.appendChild(mobileElement);
        });
      });
  
    const summaryHtml = `
      <div class="cart-summary-row">
        <span>å°è¨ˆ</span>
        <span><strong>$${subtotal}</strong></span>
      </div>
    `;
    cartSummaryEl.innerHTML = summaryHtml;
    cartModalSummaryEl.innerHTML = summaryHtml;
  
    checkoutBtn.disabled = false;
    cartModalCheckoutBtn.disabled = false;
  }

  // ==== è³¼ç‰©è»Šæ“ä½œ ====

  function addToCart(item) {
    const stock = item.stock != null ? item.stock : 0;
    if (stock <= 0) {
      showToast("æ­¤å“é …åº«å­˜ä¸è¶³");
      return;
    }
    const key = item.category + "||" + item.item;
    const existing = cart.find(c => c.key === key);

    if (existing) {
      if (existing.quantity >= existing.stock) {
        showToast("å·²é”åº«å­˜ä¸Šé™");
        return;
      }
      existing.quantity += 1;
    } else {
      cart.push({
        key,
        category: item.category,
        name: item.item,
        price: item.price,
        stock: stock,
        quantity: 1
      });
    }
    renderCart();
  }

  function changeQty(cartItem, delta) {
    const idx = cart.findIndex(c => c.key === cartItem.key);
    if (idx === -1) return;
    const item = cart[idx];
    const newQty = item.quantity + delta;
    if (newQty <= 0) {
      cart.splice(idx, 1);
    } else if (newQty > item.stock) {
      showToast("å·²é”åº«å­˜ä¸Šé™");
      return;
    } else {
      item.quantity = newQty;
    }
    renderCart();
  }

  // ==== çµå¸³æµç¨‹ï¼šå…ˆé–‹æœƒå“¡è¦–çª—ï¼Œå†çœŸæ­£é€å–® ====

  function startCheckout() {
    if (!cart.length) {
      showToast("è«‹å…ˆé¸æ“‡å“é …");
      return;
    }
    const hasMember = member.name && member.phone && member.address;
    // æœ‰å¡«éå°±çµ¦ä»–çœ‹ä¸€æ¬¡ç¢ºèªï¼Œæ²’å¡«éå°±å¼·åˆ¶å¡«å¯«
    openMemberModal(!hasMember, true);
  }

  // çœŸæ­£é€å‡ºåˆ° Apps Script
  // çœŸæ­£é€å‡ºâ†’æ”¹æˆã€Œå»ºç«‹ LINE Pay ä»˜æ¬¾ + è½‰è·³ã€
  async function submitOrder() {
    if (!cart.length) {
      showToast("è«‹å…ˆé¸æ“‡å“é …");
      return;
    }

    if (!member.name || !member.phone || !member.address) {
      showToast("è«‹å…ˆå¡«å¯«æœƒå“¡è³‡æ–™");
      openMemberModal(true, true);
      return;
    }

    let subtotal = 0;
    const itemsPayload = cart.map(c => {
      const lineTotal = c.price * c.quantity;
      subtotal += lineTotal;
      return {
        category: c.category,
        name: c.name,
        price: c.price,
        quantity: c.quantity,
        lineTotal
      };
    });

    const payload = {
      action: "createLinePayPayment",   // â˜… å‘Šè¨´å¾Œç«¯è¦å…ˆå»ºç«‹ LINE Pay ä»˜æ¬¾
      source: "WEB",
      customerName: member.name,
      customerPhone: member.phone,
      customerAddress: member.address,
      deliveryTime: member.deliveryTime,
      items: itemsPayload,
      subtotal,
      discountType: "amount",
      discountValue: 0,
      discountAmount: 0,
      total: subtotal
    };

    checkoutBtn.disabled = true;
    cartModalCheckoutBtn.disabled = true;
    checkoutBtn.textContent = "å‰å¾€ä»˜æ¬¾ä¸­â€¦";
    cartModalCheckoutBtn.textContent = "å‰å¾€ä»˜æ¬¾ä¸­â€¦";

    try {
      const resp = await fetch(API_BASE_URL, {
        method: "POST",
        body: JSON.stringify(payload)
      });
      const text = await resp.text();
      console.log("raw response:", text);
      const data = JSON.parse(text);

      if (data.status === "ok" && data.paymentUrl) {
        // ä¸åœ¨é€™è£¡æ¸…ç©ºè³¼ç‰©è»Šï¼Œç­‰ä»˜æ¬¾æˆåŠŸå†èªª
        window.location.href = data.paymentUrl;  // â˜… ç›´æ¥è·³åˆ° LINE Pay ä»˜æ¬¾ç•«é¢
      } else {
        showToast("å»ºç«‹ä»˜æ¬¾é€£çµå¤±æ•—ï¼š" + (data.message || "æœªçŸ¥éŒ¯èª¤"));
        checkoutBtn.disabled = false;
        cartModalCheckoutBtn.disabled = false;
        checkoutBtn.textContent = "é€å‡ºè¨‚å–®";
        cartModalCheckoutBtn.textContent = "é€å‡ºè¨‚å–®";
      }
    } catch (err) {
      console.error(err);
      showToast("å»ºç«‹ä»˜æ¬¾é€£çµå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
      checkoutBtn.disabled = false;
      cartModalCheckoutBtn.disabled = false;
      checkoutBtn.textContent = "é€å‡ºè¨‚å–®";
      cartModalCheckoutBtn.textContent = "é€å‡ºè¨‚å–®";
    }
  }


  // ==== äº‹ä»¶è¨»å†Š ====

  // ä¸Šæ–¹ã€Œæœƒå“¡è³‡æ–™ã€æŒ‰éˆ•ï¼šå–®ç´”é–‹è³‡æ–™è¦–çª—ï¼Œä¸é€å–®
  memberButton.addEventListener("click", () => openMemberModal(false, false));

  // æœƒå“¡è¦–çª—ã€Œå„²å­˜ã€æŒ‰éˆ•
  memberSaveBtn.addEventListener("click", () => {
    const name = memberNameInput.value.trim();
    const phone = memberPhoneInput.value.trim();
    const address = memberAddressInput.value.trim();
    const fromCheckout = memberModal.dataset.checkout === "1";
  
    if (!name || !phone || !address) {
      showToast("è«‹å¡«å¯«å§“åã€é›»è©±èˆ‡åœ°å€");
      return;
    }
  
    let deliveryTime = member.deliveryTime || "";
  
    // å¾ã€Œé€å‡ºè¨‚å–®ã€æµç¨‹é€²ä¾†ï¼Œæ‰éœ€è¦æ—¥æœŸ + æ™‚é–“
    if (fromCheckout) {
      const d = deliveryDateInput.value;
      const h = deliveryHourSelect.value;
      const m = deliveryMinuteSelect.value;
  
      if (!d || !h || !m) {
        showToast("è«‹é¸æ“‡é€é”æ—¥æœŸèˆ‡æ™‚é–“");
        return;
      }
  
      // çµ„æˆé¡ä¼¼åŸæœ¬ datetime-local çš„æ ¼å¼ï¼šYYYY-MM-DDTHH:MM
      deliveryTime = `${d}T${h}:${m}`;
    }
  
    member = { name, phone, address, deliveryTime };
    saveMemberToStorage();
    closeMemberModal();
  
    if (fromCheckout) {
      // ç›´æ¥é€å‡ºè¨‚å–®
      submitOrder();
    } else {
      showToast("æœƒå“¡è³‡æ–™å·²å„²å­˜");
    }
  });




  memberCancelBtn.addEventListener("click", () => {
    closeMemberModal();
  });


  // æ‰‹æ©Ÿè³¼ç‰©è»Š modal äº‹ä»¶
  cartFab.addEventListener("click", () => {
    cartModal.classList.add("show");
  });
  cartModalCloseBtn.addEventListener("click", () => {
    cartModal.classList.remove("show");
  });

  // æ‰‹æ©Ÿ / æ¡Œæ©Ÿçš„ã€Œé€å‡ºè¨‚å–®ã€éƒ½èµ° startCheckout
  cartModalCheckoutBtn.addEventListener("click", () => {
    if (!cart.length) {
      showToast("è«‹å…ˆé¸æ“‡å“é …");
      return;
    }
    openMemberModal(false, true);
  });
  checkoutBtn.addEventListener("click", () => {
    if (!cart.length) {
      showToast("è«‹å…ˆé¸æ“‡å“é …");
      return;
    }
    // å¾ã€Œé€å‡ºè¨‚å–®ã€é€²ä¾† â†’ éœ€è¦æ—¥æœŸ+æ™‚é–“
    openMemberModal(false, true);
  });

  // ==== åˆå§‹åŒ– ====
  initDeliveryTimeSelectors();  
  loadMemberFromStorage();
  loadMenu();
  renderCart(); // åˆå§‹åŒ–ç•«é¢
</script>

</body>
</html>
